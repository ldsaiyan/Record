# Apache HTTPD 换行解析漏洞（CVE-2017-15715）

## 介绍
在Apache2.4.0~2.4.29版本中存在一个换行解析漏洞，解析php文件时，index.php\x0a将会被解析为php文件，因此能加以利用来绕过上传黑名单。

## 版本
CentOS7
Apache2.4.\
PHP5.5\
PHP结合Apache的方式：PHP作为Apache的模块

![](https://github.com/saiyanlee/Record/blob/master/Sys/Apache/Apache%20HTTPD%20%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-15715%EF%BC%89/images/1.png)


## 漏洞复现
写个文件上传功能页面upload.php，并设置黑名单：php、phtml、pht、php3 php4、php5。

需要注意的是$_FILES['filename']['name']这样获取的文件名会自动去电换行符（参考别人的文章得知）。

```
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload</title>
</head>
<body>
<form action="" enctype='multipart/form-data' method="post" >
    <input type="file" name="filename" id="filename" >
    <input type="text" name="name" id="text">
    <input type="submit" name="button" value="点击上传" onmousemove="return checksubmit()">
</form>
<script>
    function checksubmit () {
        var name = document.getElementById("filename");
        var filename = name.value;
        document.getElementById("text").value = filename;
    }

</script>
</body>
</html>
<?php
// 请求失败
if (empty($_POST)) {
    exit();
}

// 上传失败
if ($_FILES['filename']['error'] != 0) {
    exit("上传失败");
}

// 获取文件名
$name = basename($_POST['name']);
print_r($name);

// 设置黑名单
$blackList = array('php','phtml','pht','php3','php4','php5');
$ext = pathinfo($name,PATHINFO_EXTENSION);
if (in_array($ext,$blackList)) {
    exit("不支持此文件");
} else {
    // 从tmp移动到upload
    move_uploaded_file($_FILES['filename']['tmp_name'],'./'.$name);
    echo "OK";
}

?>
```

正常流程上传fcku.php，失败~

![](https://github.com/saiyanlee/Record/blob/master/Sys/Apache/Apache%20HTTPD%20%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-15715%EF%BC%89/images/2.png)

开启BP，同样上传fcku.php，截包

![](https://github.com/saiyanlee/Record/blob/master/Sys/Apache/Apache%20HTTPD%20%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-15715%EF%BC%89/images/3.png)

在hex功能中往fcku.php后面添加一个0a换行符（0a代表ASCII十六进制的换行）

![](https://github.com/saiyanlee/Record/blob/master/Sys/Apache/Apache%20HTTPD%20%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-15715%EF%BC%89/images/4.png)

上传成功~

![](https://github.com/saiyanlee/Record/blob/master/Sys/Apache/Apache%20HTTPD%20%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-15715%EF%BC%89/images/5.png)

访问一下

![](https://github.com/saiyanlee/Record/blob/master/Sys/Apache/Apache%20HTTPD%20%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-15715%EF%BC%89/images/6.png)

